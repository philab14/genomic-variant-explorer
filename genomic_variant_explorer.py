# -*- coding: utf-8 -*-
"""genomic-variant-explorer

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1p5VV7qb11qEL0JUbUjybJoot1tbBXSUc
"""

!pip install --quiet scikit-allel pandas matplotlib

import pandas as pd
import allel
import matplotlib.pyplot as plt

# Download chromosome 22 VCF (Phase 3)
!wget -O chr22.vcf.gz \
"https://ftp.1000genomes.ebi.ac.uk/vol1/ftp/release/20130502/ALL.chr22.phase3_shapeit2_mvncall_integrated_v5b.20130502.genotypes.vcf.gz"

#unzip the VCF file
!gunzip chr22.vcf.gz

!ls

!pip install cyvcf2

from cyvcf2 import VCF
import pandas as pd
import os # Import os module for file operations

vcf_path = "chr22.vcf"
vcf_gz_path = "chr22.vcf.gz"
download_url = "https://ftp.1000genomes.ebi.ac.uk/vol1/ftp/release/20130502/ALL.chr22.phase3_shapeit2_mvncall_integrated_v5b.20130502.genotypes.vcf.gz"

# Check if the unzipped VCF file exists and is readable
if not os.path.exists(vcf_path) or os.path.getsize(vcf_path) == 0:
    print(f"'{vcf_path}' not found or is empty. Attempting to download and unzip...")

    # Ensure previous compressed file is removed to avoid conflicts
    if os.path.exists(vcf_gz_path):
        os.remove(vcf_gz_path)

    # Download the gzipped VCF file
    !wget -O {vcf_gz_path} "{download_url}"

    # Unzip the file
    !gunzip {vcf_gz_path}

    # Verify the unzipped file exists
    if not os.path.exists(vcf_path):
        raise FileNotFoundError(f"Failed to create '{vcf_path}' after download and unzip.")
    else:
        print(f"'{vcf_path}' successfully created.")
else:
    print(f"'{vcf_path}' already exists.")

# Now proceed with opening the VCF file
vcf = VCF(vcf_path)

# Convert to a DataFrame (CHROM, POS, REF, ALT, QUAL, FILTER, INFO)
records = []
for variant in vcf:
    records.append([
        variant.CHROM,
        variant.POS,
        variant.REF,
        str(variant.ALT),
        variant.QUAL,
        variant.FILTER,
        variant.INFO
    ])

df = pd.DataFrame(records, columns=["CHROM", "POS", "REF", "ALT", "QUAL", "FILTER", "INFO"])
df.head()

# Quick overview of the DataFrame
df.info()
df.describe()

# See how many variants per chromosome (though it's all chr22)
df['CHROM'].value_counts()

from google.colab import data_table

#Step 2 — Extract useful INFO fields
def extract_info_field(info, key):
    try:
        for item in info.split(";"):
            if item.startswith(key + "="):
                return item.split("=")[1]
    except:
        return None

# Example: extract allele frequency if present
df['AF'] = df['INFO'].apply(lambda x: extract_info_field(x, 'AF'))
df['AF'].head()

#Step 3 — Filter Variants


# High-quality variants
df_hq = df[df['QUAL'] >= 30]

# Optional: filter rare variants (allele frequency < 0.01)
df_rare = df_hq[df_hq['AF'].astype(float) < 0.01]

# Keep only SNPs
df_snps = df_rare[df_rare['REF'].str.len() == 1]
df_snps = df_snps[df_snps['ALT'].str.len() == 1]

#Step 4 — Variant Summary
print("Total variants:", len(df))
print("High-quality variants:", len(df_hq))
print("Rare SNPs:", len(df_snps))

#Step 5 — Variant Distribution Plot
import matplotlib.pyplot as plt

plt.figure(figsize=(12,4))
plt.hist(df_snps['POS'], bins=200, color='purple')
plt.title('Variant Distribution Across Chromosome 22')
plt.xlabel('Genomic Position (bp)')
plt.ylabel('Variant Count')
plt.show()

#Step 6 — Transition / Transversion Analysis (Optional but Useful)
def classify_snp(ref, alt):
    transitions = [('A','G'),('G','A'),('C','T'),('T','C')]
    return "Transition" if (ref, alt) in transitions else "Transversion"

df_snps['TYPE'] = df_snps.apply(lambda r: classify_snp(r['REF'], r['ALT']), axis=1)
df_snps['TYPE'].value_counts()

#Gene-Level Variant Mapping
!pip install --upgrade pyarrow==15.0.2 polars==1.28.0 --quiet
!pip install pyensembl --quiet

from pyensembl import EnsemblRelease
import numpy as np

# Load Ensembl annotation (use GRCh37 for 1000 Genomes)
ensembl = EnsemblRelease(75)

def get_gene(chrom, pos):
    try:
        genes = ensembl.genes_at_locus(contig=chrom, position=int(pos))
        if genes:
            return ",".join([g.gene_name for g in genes])
        else:
            return None
    except:
        return None

df_snps['GENE'] = df_snps.apply(lambda r: get_gene(r['CHROM'], r['POS']), axis=1)
df_snps[['CHROM','POS','REF','ALT','GENE']].head()

gene_counts = df_snps['GENE'].value_counts()
gene_counts.head(10)

#Functional Annotation with SnpEff/VEP

# If INFO contains ANN (SnpEff annotation), you can extract impact:

def extract_ann_impact(info):
    if "ANN=" in info:
        ann_field = info.split("ANN=")[1].split(",")[0]  # first annotation
        impact = ann_field.split("|")[2]  # SnpEff impact field
        return impact
    return None

df_snps['SnpEff_IMPACT'] = df_snps['INFO'].apply(extract_ann_impact)
df_snps[['CHROM','POS','REF','ALT','SnpEff_IMPACT']].head()

#Filter high-impact variants:

high_impact = df_snps[df_snps['SnpEff_IMPACT'] == 'HIGH']
print(f"Number of high-impact variants: {len(high_impact)}")